"use strict";(function(){function t(t){return t.charAt(0).toUpperCase()+t.slice(1)}function e(r,n,a){var s={},f=[],l=!1,c=!1,h=[],p={},d=this;i.forEach(n,function(e,r){var o=t(r);d["from"+o]=function(t){d.set(t,r)},d["to"+o]=function(){if(i.isObject(n)&&n.hasOwnProperty(r)&&i.isFunction(n[r].toFn))return n[r].toFn(d);throw new Error("Cannot convert it to ",r)}});for(var v in r){f.push(v);var y=r[v];if(!i.isObject(y))throw new Error("Invalid property. Property must be an object");if(i.isUndefined(y).$type)throw new Error("Invalid property type. Undefined $type attribute");var m=y.$type;y.$pk&&(h.push(v),p[v]=!0);var w=null;if((y.$default||i.isEqual(y.$default,""))&&(w=i.isFunction(y.$default)?y.$default():y.$default),u.hasOwnProperty(m))s[v]={type:m,checkFn:u[m].checkFn,value:w};else if(new m instanceof e)s[v]={type:"model",Type:m,checkFn:function(t){if(i.isNull(t))return!0;var e=this.Type;return e.prototype.isPrototypeOf(t)},value:w};else{if(!(new m instanceof o))throw new Error("Invalid property type "+v);s[v]={type:"arraymodel",Type:m,checkFn:function(t){if(i.isNull(t))return!0;var e=this.Type;return e.prototype.isPrototypeOf(t)},value:w}}if(!s[v].checkFn(w))throw new Error("Invalid $default value for key "+v+": "+w)}var b=function(t,e){if(i.isObject(n)&&n.hasOwnProperty(e)&&i.isFunction(n[e].fromFn))return void n[e].fromFn(t,d);throw new Error("Cannot convert it to "+e)};this.set=function(t,e){if(c)throw new Error("Object is immutable");if(!i.isObject(t))throw new Error("Invalid object");if(e)return void b(t,e);for(var r in t){if(!s.hasOwnProperty(r))throw new Error("Invalid attribute "+r);if(s[r].checkFn(t[r]))s[r].value=t[r];else{if(!i.isUndefined(t[r]))throw new Error("Invalid attribute "+r);s[r].value=null}}},this.get=function(t){if(!s.hasOwnProperty(t))throw new Error("Trying to access an invalid key");return s[t].value},this.attributeNames=function(){return f},this.primaryKey=function(){var t={};return i.forEach(h,function(e){t[e]=s[e].value}),t},this.toJSON=function(){var t={};for(var r in s){var n=s[r];if(i.isNull(n.value))t[r]=null;else if(i.isEqual(n.type,"array"))for(var o=t[r]=[],u=0;u<n.value.length;++u){var a=n.value[u];o.push(a instanceof e?a.toJSON():a)}else t[r]=i.isEqual(n.type,"model")||i.isEqual(n.type,"arraymodel")?n.value.toJSON():n.value}return this.isDeleted()&&(t.$op="delete"),t},this.toString=function(){return JSON.stringify(this.toJSON(),null,2)},this.isEqual=function(t){if(i.isEqual(this,t))return!0;if(!i.isEqual(f,t.attributeNames()))return!1;for(var e in s){var r=s[e],n=t.get(e);if(i.isEqual(r.type,"model")){if(!r.value.isEqual(n))return!1}else if(r.value!==n)return!1}return!0},this.setDeleted=function(){l=!0},this.isDeleted=function(){return l},this.copy=function(){return c?this:this.mutableCopy()},this.mutableCopy=function(){var t=this.constructor,r=new t;return i.forEach(s,function(t,n){var u={};u[n]=t.value instanceof e||t.value instanceof o?t.value.mutableCopy():i.cloneDeep(t.value),r.set(u)}),r};var E=function(t,e,r){var n={};n[t]=e,r.set(n)};this.diff=function(t){if(i.isEqual(this,t))return null;if(!t){var r=this.mutableCopy();return r.setDeleted(),r.immutable(),r}var n=this.constructor,u=new n;if(a)return a(this,t,u);for(var s=!1,f=this.attributeNames(),l=0;l<f.length;++l){var c=f[l],h=this.get(c),d=t.get(c);if(h instanceof e||h instanceof o){var v=h.diff(d);v?(E(c,v,u),s=!0):u.removeAttribute(c)}else if(p.hasOwnProperty(c)){if(!i.isEqual(h,d))throw new Error(c+" must have same value "+h+", "+d);E(c,h,u)}else i.isEqual(h,d)?u.removeAttribute(c):(E(c,d,u),s=!0)}return s?u:null},this.removeAttribute=function(t){if(c)throw new Error("Object is Immutable");delete s[t]},this.immutable=function(){c=!0;for(var t in s){var e=s[t];i.isEqual(e.type,"model")&&e.value&&!e.value.isImmutable()&&e.value.immutable()}return this},this.isImmutable=function(){return c},Object.freeze(this)}function r(r,n,o){if(!new r instanceof e)throw new Error("Type must be inherit from Model");var u=[],a=!1,s=this;i.forEach(n,function(e,r){var n=t(r);s["from"+n]=function(t){e.fromFn(t,s)},s["to"+n]=function(){return e.toFn(s)}}),this.insertAt=function(t,e){if(a)throw new Error("Object is immutable");if(u.length<t)throw new Error("Can't insert in the desired index");if(!(e instanceof r))throw new Error("Cannot add the object. Invalid type");u.splice(t,0,e)},this.append=function(t){if(a)throw new Error("Object is immutable");if(!(t instanceof r))throw new Error("Cannot add the object. Invalid type");u.push(t)},this.prepend=function(t){this.insertAt(0,t)},this.removeAt=function(t){if(a)throw new Error("Object is immutable");u.splice(t,1)},this.get=function(t){return u[t]},this.length=function(){return u.length},this.toJSON=function(){var t=[];return i.forEach(u,function(e){t.push(e.toJSON())}),t},this.toString=function(){return JSON.stringify(this.toJSON(),null,2)},this.isEqual=function(t){if(i.isEqual(t,this))return!0;if(t.length()!=this.length())return!1;for(var e=0;e<u.length;++e)if(!this.get(e).isEqual(t.get(e)))return!1;return!0},this.copy=function(){return a?this:this.mutableCopy()},this.mutableCopy=function(){var t=this.constructor,e=new t;return i.forEach(u,function(t){e.append(t.mutableCopy())}),e},this.diff=function(t){if(i.isEqual(this,t))return null;var e=this.constructor,r=new e;if(!t){for(var n=0;n<u.length;++n)r.append(u[n].diff(null));return r}if(o)return o(this,t,r);var a,s,f={};for(n=0;n<u.length;++n)a=JSON.stringify(u[n].primaryKey()),f[a]=u[n];for(n=0;n<t.length();++n)a=JSON.stringify(t.get(n).primaryKey()),f.hasOwnProperty(a)?(s=f[a].diff(t.get(n)),s&&r.append(s),delete f[a]):r.append(t.get(n));for(a in f)r.append(f[a].diff(null));return r.length()?r:null},this.immutable=function(){return a=!0,i.forEach(u,function(t){t.immutable()}),this},this.isImmutable=function(){return a},Object.freeze(this)}var n=this,i=n._;if("undefined"==typeof i){if("undefined"==typeof require)throw new Error("typedmodel requires lodash");i=require("lodash")}var o=null,u={bool:{checkFn:function(t){return i.isNull(t)||i.isBoolean(t)}},string:{checkFn:function(t){return i.isNull(t)||i.isString(t)}},number:{checkFn:function(t){return i.isNull(t)||i.isNumber(t)}},date:{checkFn:function(t){return i.isNull(t)||i.isDate(t)}},array:{checkFn:function(t){return i.isNull(t)||i.isArray(t)}}};"undefined"!=typeof module&&module.exports?(module.exports.Model=e,module.exports.ArrayModel=r):(n.Model=e,n.ArrayModel=r),"function"==typeof define&&define.amd&&define("typedmodel",[],function(){return{Model:e,ArrayModel:r}}),o=r}).call(this);
